# Automagik Agents MCP Tool

This tool provides MCP (Model Context Protocol) integration for the Automagik Agents API using FastMCP's native OpenAPI support.

## Features

- **Dynamic OpenAPI Integration**: Automatically converts OpenAPI specifications to MCP tools and resources
- **Smart Component Naming**: Handles long operationIds with intelligent name mapping and truncation
- **Configurable Route Mapping**: Customizable rules for converting API endpoints to MCP components
- **Authentication Support**: Built-in API key authentication
- **Health Endpoint Filtering**: Optional exclusion of health check endpoints

## Configuration

The tool can be configured using environment variables or a `.env` file:

```bash
# Required
AUTOMAGIK_AGENTS_API_KEY=your_api_key_here
AUTOMAGIK_AGENTS_BASE_URL=http://192.168.112.148:8881

# Optional
AUTOMAGIK_AGENTS_OPENAPI_URL=http://192.168.112.148:8881/api/v1/openapi.json
AUTOMAGIK_AGENTS_TIMEOUT=30
AUTOMAGIK_AGENTS_MAX_NAME_LENGTH=56
AUTOMAGIK_AGENTS_AUTO_TRUNCATE=true
AUTOMAGIK_AGENTS_EXCLUDE_HEALTH=true
```

### Configuration Options

- `AUTOMAGIK_AGENTS_API_KEY`: API key for authentication (required)
- `AUTOMAGIK_AGENTS_BASE_URL`: Base URL for the API (default: http://192.168.112.148:8881)
- `AUTOMAGIK_AGENTS_OPENAPI_URL`: URL to fetch OpenAPI specification
- `AUTOMAGIK_AGENTS_TIMEOUT`: Request timeout in seconds (default: 30)
- `AUTOMAGIK_AGENTS_MAX_NAME_LENGTH`: Maximum length for MCP component names (default: 56)
- `AUTOMAGIK_AGENTS_AUTO_TRUNCATE`: Automatically truncate long component names (default: true)
- `AUTOMAGIK_AGENTS_EXCLUDE_HEALTH`: Exclude health check endpoints (default: true)

## Naming Issue Resolution

### Problem
The original implementation suffered from extremely long operationIds generated by FastAPI, such as:
- `get_claude_code_run_status_api_v1_agent_claude_code_run__run_id__status_get` (78 characters)
- `run_claude_code_workflow_api_v1_agent_claude_code__workflow_name__run_post` (77 characters)

These exceeded FastMCP's 56-character limit for component names, causing MCP registration failures.

### Solution
The tool now implements a comprehensive naming strategy:

1. **Custom Name Mapping**: Pre-defined mappings for known long operationIds
2. **Intelligent Truncation**: Automatic name shortening with meaningful extraction
3. **Validation**: Runtime validation of all component names
4. **Configuration**: Configurable limits and truncation behavior

### Custom Name Mappings

The tool includes pre-defined mappings for common long names:

```python
{
    "get_claude_code_run_status_api_v1_agent_claude_code_run__run_id__status_get": "claude_code_run_status",
    "run_claude_code_workflow_api_v1_agent_claude_code__workflow_name__run_post": "claude_code_run_workflow",
    "list_claude_code_workflows_api_v1_agent_claude_code_workflows_get": "claude_code_workflows",
    # ... more mappings
}
```

## Preventing Naming Issues in Dynamic OpenAPI

### Analysis Tool

Use the included `openapi_utils.py` to analyze any OpenAPI specification:

```python
from automagik_tools.tools.automagik_agents.openapi_utils import print_analysis_report

# Analyze an OpenAPI spec
print_analysis_report("http://your-api.com/openapi.json")
```

This will generate a detailed report showing:
- Operations exceeding the character limit
- Suggested short names
- Potential naming conflicts
- Ready-to-use mapping code

### Best Practices

1. **Analyze Before Integration**: Always run the analysis tool on new OpenAPI specs
2. **Use Meaningful operationIds**: When designing APIs, use concise, meaningful operationIds
3. **Configure Limits**: Set appropriate `max_component_name_length` for your use case
4. **Enable Auto-Truncation**: Use `auto_truncate_names=true` for automatic handling
5. **Custom Route Maps**: Use route mapping to organize endpoints logically

### Example Analysis Output

```
=== OpenAPI Naming Analysis Report ===
URL: http://192.168.112.148:8881/api/v1/openapi.json
Max allowed length: 56 characters

Statistics:
  Total operations: 45
  Average name length: 52.3
  Longest name: 78 chars
  Shortest name: 12 chars

⚠️  Found 19 names exceeding 56 characters:
  • get_claude_code_run_status_api_v1_agent_claude_code_run__run_id__status_get (78 chars)
    Path: GET /api/v1/agent/claude-code/run/{run_id}/status
    Suggested: get_claude_code

=== Suggested MCP Names Mapping ===
Add this to your get_custom_mcp_names() function:
{
    "get_claude_code_run_status_api_v1_agent_claude_code_run__run_id__status_get": "get_claude_code",
    // ... more mappings
}
```

## Route Mapping

The tool uses intelligent route mapping to organize API endpoints:

- **Management Operations**: POST/PUT/DELETE operations become tools
- **Data Retrieval**: GET operations become resources or resource templates
- **Health Endpoints**: Excluded by default to reduce clutter
- **Workflow Operations**: Special handling for workflow-related endpoints

### Custom Route Maps

You can customize the route mapping by modifying the `create_custom_route_maps()` function:

```python
def create_custom_route_maps(config: AutomagikAgentsConfig):
    return [
        # Make all analytics endpoints tools
        RouteMap(
            methods=["GET"], 
            pattern=r"^/api/v1/analytics/.*", 
            mcp_type=MCPType.TOOL
        ),
        
        # Exclude internal endpoints
        RouteMap(
            pattern=r"^/internal/.*", 
            mcp_type=MCPType.EXCLUDE
        ),
    ]
```

## Usage

### As a Standalone Server

```bash
python -m automagik_tools.tools.automagik_agents
```

### Within Automagik Tools Framework

The tool integrates automatically with the automagik-tools framework and will be available as an MCP server when properly configured.

### Programmatic Usage

```python
from automagik_tools.tools.automagik_agents import create_tool
from automagik_tools.tools.automagik_agents.config import AutomagikAgentsConfig

# Create with custom config
config = AutomagikAgentsConfig(
    api_key="your-key",
    base_url="http://your-api.com",
    max_component_name_length=50,
    auto_truncate_names=True
)

mcp_server = create_tool(config)
```

## Troubleshooting

### Long Component Names

If you encounter errors about component names being too long:

1. **Check the logs** for specific names causing issues
2. **Run the analysis tool** to identify problematic operationIds
3. **Add custom mappings** to `get_custom_mcp_names()`
4. **Enable auto-truncation** in configuration
5. **Adjust the length limit** if needed

### Name Conflicts

If multiple operations map to the same short name:

1. **Review the analysis report** for conflicts
2. **Provide unique custom names** for conflicting operations
3. **Use more specific naming patterns**

### API Connection Issues

- Verify the `base_url` and `openapi_url` are correct
- Check that the API key has proper permissions
- Ensure the API is accessible from your network
- Review timeout settings if requests are slow

## Development

### Adding New Custom Names

1. Identify long operationIds using the analysis tool
2. Add mappings to `get_custom_mcp_names()`
3. Test with `validate_mcp_names()` utility
4. Update documentation

### Testing

```bash
# Run the analysis tool
python -m automagik_tools.tools.automagik_agents.openapi_utils

# Test the MCP server
python -m automagik_tools.tools.automagik_agents
```

## References

- [FastMCP Documentation](https://gofastmcp.com/servers/openapi#component-names)
- [Model Context Protocol Specification](https://modelcontextprotocol.io/)
- [OpenAPI Specification](https://swagger.io/specification/)

## Contributing

When contributing to this tool:

1. **Always run the analysis tool** on any new OpenAPI integrations
2. **Add appropriate custom name mappings** for long operationIds
3. **Update the documentation** with new configuration options
4. **Test thoroughly** with various OpenAPI specifications
5. **Follow the naming conventions** established in this tool
